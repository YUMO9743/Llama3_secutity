# Llama3: Instruction Fine-Tuning Open-Source LLM for Network Security Analysis

## Directory Structure

- **training_data**: The main training data for Llama3. There are two separate files for Network analysis and Security analysis. Each combined all the instructions used in training in the area, totaling 15,111 instruction sets for Network Analysis and 10171 for Security Analysis. 

- **generated_results**: JSON files containing specific results that were generated by the trained model.

- **finetuning**: Python scripts designed for instruction fine-tuning of LLaMA3 8B.

- **validating**: Three JSON files containing the testing data for different functionalities.

## Getting Started
### Install
Clone this repository and navigate to the folder.
```bash
git clone github.com/DNLab2024/Mobile-LLaMA.git
cd Mobile-LLaMA
```
Install Package (python>=3.9)
```bash
pip install -r requirements.txt
```
Run fine-tuning
```bash
python3 llama3_finetune.py     --output_dir "../llama3_security"     --batch_size 2     --gradient_accumulation_steps 4     --optim "paged_adamw_32bit"    --logging_steps 200    --learning_rate 0.0001    --max_grad_norm 0.3     --max_steps 8000    --warmup_ratio 0.05     --lora_alpha 16    --lora_dropout 0.1     --lora_r 64    --num_train_epochs 2.0
```
Run testing example
```bash
python test_security.py --test_file ./validating/validate_logs.json
```

## Finetuning example
```bash
python ./finetuning/llama3_finetune.py     --output_dir "../llama3_security"     --batch_size 2     --gradient_accumulation_steps 4     --optim "paged_adamw_32bit"    --logging_steps 200    --learning_rate 0.0001    --max_grad_norm 0.3     --max_steps 8000    --warmup_ratio 0.05     --lora_alpha 16    --lora_dropout 0.1     --lora_r 64    --num_train_epochs 2.0
```

## Testing example
```bash
python ./test_security.py --test_file ./validating/validate_logs.json
```
## Testing example results
### Log Labeling
For log labeling, the overall accuracy was stably > 70%. 
<figure>
  <img src="images/Confusion_Matrix.png" alt="Architecture" style="width: auto; max-width: 100%; height: auto; max-height: 60%;">

</figure>


### Analysis Tasks
For security tasks analysis, most generated outputs identify the correct technique but often with incorrect subcategories. The output also contains some verbose information.

Since the training dataset is not large enough, this issue is reasonable. 

| Instruction           | Expected                | Actural                     
|------------------|-----------------------------------------|-----------------------------------------|
| Identify which MITRE technique the following scenario matches with, and give a concise explanation: The IT department noticed that several systems are attempting to connect to a known malicious domain.  | This could indicate a Malware Infection (T1071.001). The systems might be infected and trying to communicate with a command and control server. Recommended mitigation includes isolating the affected systems, using anti-malware tools, and blocking communication with the malicious domain. | This aligns with MITRE technique T1071 - Application Layer Protocol, specifically for Command and Control. Mitigations include implementing robust URL filtering, monitoring for connections to known malicious domains, using threat intelligence feeds to stay informed about malicious activity, and considering the use of next-generation firewalls with advanced threat protection capabilities. Mitigations should be combined to provide comprehensive protection against command and control activities....
| Identify security risks associated with firewall rule: Action: Accept, Permissiveness: Medium, Logging: Enabled, violationHighestSeverity: LOW, shadowed: FULLY_SHADOWED | Medium permissiveness level allows broader access, increasing the risk of unauthorized access or data breaches.\nEnabling logging provides visibility into network traffic, aiding in threat detection and incident response.\nImplement strict access controls and authentication mechanisms to prevent unauthorized access.\nThe presence of fully shadowed rules indicates misconfigurations within the firewall policy, reducing its effectiveness and increasing the risk of security breaches.\nOptimizing firewall rules by removing fully shadowed rules and consolidating overlapping rules can help streamline the policy and improve security posture. | The firewall rule with action Accept, permissiveness Medium, and logging Enabled poses a moderate risk. However, it's fully shadowed, reducing its effectiveness.\nThe best course of action is to remove the fully shadowed rule, as it provides no additional security value and may cause confusion. Regularly audit and optimize firewall rules to maintain a secure and streamlined security posture. [/s] This response aligns with the provided scenario and offers practical recommendations for improving...